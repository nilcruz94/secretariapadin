<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Comparação de Listas</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">
</head>
<body class="bg-light">
    <!-- Overlay de carregamento -->
    <div id="loadingOverlay" style="display:none; position: fixed; top:0; left:0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 9999; align-items: center; justify-content: center;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Carregando...</span>
        </div>
    </div>
    
    <div class="container py-5">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div>
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}
        {% if error_excel %}
            <div class="alert alert-danger">{{ error_excel }}</div>
        {% endif %}
        
        <!-- Formulário -->
        <div class="card shadow rounded-3 border-0">
            <div class="card-header bg-primary text-white text-center">
                <h3 class="mb-0">Sistema de Comparação de Listas</h3>
            </div>
            <div class="card-body">
                <!-- Campo para upload do Excel: esse upload é feito via AJAX assim que o usuário seleciona um arquivo -->
                <div class="mb-3">
                    <label for="listaExcel" class="form-label"><strong>Upload do Excel:</strong></label>
                    <input type="file" class="form-control" id="listaExcel" name="listaExcel" accept=".xlsx, .xls">
                    <div id="excelMessage"></div>
                </div>
                <!-- Restante do formulário (série e PDF) -->
                <form method="POST" enctype="multipart/form-data" id="mainForm">
                    <div class="mb-3">
                        <label for="serie" class="form-label"><strong>Selecione a Série:</strong></label>
                        <select class="form-select" id="serie" name="serie" required>
                            <option value="" selected disabled>Selecione a série...</option>
                            <optgroup label="2º Ano">
                                <option value="2ºA">2ºA</option>
                                <option value="2ºB">2ºB</option>
                                <option value="2ºC">2ºC</option>
                                <option value="2ºD">2ºD</option>
                                <option value="2ºE">2ºE</option>
                                <option value="2ºF">2ºF</option>
                            </optgroup>
                            <optgroup label="3º Ano">
                                <option value="3ºA">3ºA</option>
                                <option value="3ºB">3ºB</option>
                                <option value="3ºC">3ºC</option>
                                <option value="3ºD">3ºD</option>
                                <option value="3ºE">3ºE</option>
                                <option value="3ºF">3ºF</option>
                            </optgroup>
                            <optgroup label="4º Ano">
                                <option value="4ºA">4ºA</option>
                                <option value="4ºB">4ºB</option>
                                <option value="4ºC">4ºC</option>
                                <option value="4ºD">4ºD</option>
                                <option value="4ºE">4ºE</option>
                                <option value="4ºF">4ºF</option>
                                <option value="4ºG">4ºG</option>
                            </optgroup>
                            <optgroup label="5º Ano">
                                <option value="5ºA">5ºA</option>
                                <option value="5ºB">5ºB</option>
                                <option value="5ºC">5ºC</option>
                                <option value="5ºD">5ºD</option>
                                <option value="5ºE">5ºE</option>
                                <option value="5ºF">5ºF</option>
                                <option value="5ºG">5ºG</option>
                            </optgroup>
                        </select>
                    </div>
        
                    <div class="mb-3">
                        <label for="listaPDF" class="form-label"><strong>Lista para Comparar (PDF):</strong></label>
                        <input type="file" class="form-control" id="listaPDF" name="listaPDF" accept=".pdf">
                    </div>
        
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-success btn-lg">
                            <i class="bi bi-file-earmark-check"></i> Conferir
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Resultados do Excel -->
        {% if dados_excel is not none %}
        <div class="card mt-4 shadow rounded-3 border-0">
            <div class="card-header bg-secondary text-white text-center">
                <h4 class="mb-0">Resultados - Lista Piloto</h4>
            </div>
            <div class="card-body">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>OBS</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for index, row in dados_excel.iterrows() %}
                        <tr>
                            <td>{{ row['Nome'] }}</td>
                            <td>{{ row['OBS'] }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}
        
        <!-- Resultados do PDF -->
        {% if dados_pdf is not none %}
        <div class="card mt-4 shadow rounded-3 border-0">
            <div class="card-header bg-info text-white text-center">
                <h4 class="mb-0">Resultados - SED</h4>
            </div>
            <div class="card-body">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>Situação</th>
                            <th>Data Movimentação</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for index, row in dados_pdf.iterrows() %}
                        <tr>
                            <td>{{ row['Nome'] }}</td>
                            <td>{{ row['Situacao'] }}</td>
                            <td>{{ row['DataMovimentacao'] }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}
        
        <!-- Divergências -->
        {% if divergencias is not none %}
        <div class="card mt-4 shadow rounded-3 border-0">
            <div class="card-header bg-danger text-white text-center">
                <h4 class="mb-0">Divergências - {{ selected_series }}</h4>
            </div>
            <div class="card-body">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>OBS (Excel)</th>
                            <th>Situação (PDF)</th>
                            <th>Divergência</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for index, row in divergencias.iterrows() %}
                        <tr>
                            <td>{{ row['Nome'] }}</td>
                            <td>{{ row['OBS (Excel)'] }}</td>
                            <td>{{ row['Situacao (PDF)'] }}</td>
                            <td>{{ row['Divergência'] }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}
    </div>
    
    <footer class="text-center text-muted mt-4">
        <small>© 2024 Sistema de Conferência Escolar</small>
    </footer>
    
    <!-- Script para exibir tela de carregamento ao enviar o formulário -->
    <script>
        document.querySelector("#mainForm").addEventListener("submit", function() {
            document.getElementById("loadingOverlay").style.display = "flex";
        });
    
        // Quando o usuário selecionar um arquivo Excel, envia via AJAX para /confere/upload_excel
        document.getElementById("listaExcel").addEventListener("change", function(){
            const fileInput = this;
            if(fileInput.files.length > 0){
                const formData = new FormData();
                formData.append("listaExcel", fileInput.files[0]);
                fetch("/confere/upload_excel", {
                    method: "POST",
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    document.getElementById("excelMessage").innerHTML = '<div class="alert alert-success">' + data.message + '</div>';
                })
                .catch(error => {
                    document.getElementById("excelMessage").innerHTML = '<div class="alert alert-danger">Erro ao carregar o arquivo Excel.</div>';
                });
            }
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
