{% extends "base.html" %}

{% block title %}Quadro de Transferências{% endblock %}

{% block extra_styles %}
  .transfer-wrapper {
    position: relative;
    z-index: 1;
    background: rgba(255, 255, 255, 0.98);
    padding: 32px 28px 24px;
    border-radius: 16px;
    box-shadow: 0 18px 40px rgba(0, 0, 0, 0.35);
    width: 100%;
    max-width: 820px;
    color: #283E51;
  }

  .transfer-header h2 {
    font-size: 1.4rem;
    font-weight: 600;
    margin-bottom: 6px;
  }

  .transfer-header p {
    font-size: 0.9rem;
    color: #5d6c7a;
    margin-bottom: 18px;
  }

  .flash-container {
    margin-bottom: 14px;
  }

  .section-title {
    font-size: 0.9rem;
    font-weight: 600;
    color: #374a5a;
    margin-bottom: 6px;
  }

  .badge-optional {
    display: inline-block;
    font-size: 0.72rem;
    font-weight: 600;
    color: #5d6c7a;
    background: #eef2f7;
    border: 1px solid #d7dee8;
    border-radius: 999px;
    padding: 2px 8px;
    margin-left: 8px;
  }

  .upload-group {
    margin-top: 14px;
    margin-bottom: 18px;
  }

  .dropzone {
    position: relative;
    border-radius: 12px;
    border: 1px dashed #d0d7de;
    padding: 16px 18px;
    background: #f9fafb;
    display: flex;
    align-items: center;
    gap: 14px;
    cursor: pointer;
    transition:
      border-color 0.18s ease,
      background 0.18s ease,
      box-shadow 0.18s ease;
  }

  .dropzone:hover {
    border-color: #4B79A1;
    background: #f5f7ff;
    box-shadow: 0 6px 14px rgba(15, 23, 42, 0.07);
  }

  .dropzone.dragover {
    border-color: #4B79A1;
    background: #eef2ff;
  }

  .dropzone-icon-circle {
    width: 44px;
    height: 44px;
    border-radius: 999px;
    background: linear-gradient(135deg, #283E51, #4B79A1);
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
  }

  .dropzone-icon-circle i {
    color: #ffffff;
    font-size: 1.3rem;
  }

  .dropzone-text-block {
    flex: 1;
  }

  .dropzone-title {
    margin: 0;
    font-size: 0.95rem;
    font-weight: 600;
    color: #283E51;
  }

  .dropzone-subtitle {
    margin: 2px 0 0;
    font-size: 0.8rem;
    color: #6b7280;
  }

  .dropzone-filename {
    margin-top: 4px;
    font-size: 0.8rem;
    color: #4b5563;
    font-style: italic;
  }

  .dropzone input[type="file"] {
    position: absolute;
    inset: 0;
    opacity: 0;
    cursor: pointer;
  }

  .helper-text {
    font-size: 0.8rem;
    color: #6b7280;
    margin-top: 4px;
  }

  .btn-generate {
    margin-top: 18px;
    border-radius: 999px;
    font-size: 0.95rem;
    padding: 10px 18px;
    font-weight: 600;
  }

  .back-links {
    margin-top: 18px;
    display: flex;
    justify-content: space-between;
    gap: 10px;
    flex-wrap: wrap;
    align-items: center;
  }

  .back-links a {
    font-size: 0.85rem;
  }

  .info-box {
    background: #f4f6fb;
    border: 1px solid #e0e6ed;
    border-radius: 12px;
    padding: 12px 14px;
    margin-top: 10px;
    margin-bottom: 14px;
  }

  .info-box strong {
    color: #283E51;
  }

  @media (max-width: 768px) {
    .transfer-wrapper {
      padding: 24px 18px 20px;
    }
  }
{% endblock %}

{% block content %}
  {% set enable_eja = enable_eja|default(false) %}

  <div class="transfer-wrapper">
    <div class="transfer-header">
      <h2>Quadro de Transferências</h2>
      <p>
        Gere o Quadro Informativo (TE, MC, MCC) a partir da aba <strong>LISTA CORRIDA</strong>
        da Lista Piloto, filtrando por período.
        {% if enable_eja %}
          A EJA está habilitada e pode ser enviada opcionalmente.
        {% else %}
          A EJA está desativada no sistema no momento.
        {% endif %}
      </p>

      <div class="info-box">
        <strong>Dica:</strong> se você não selecionar a lista do Fundamental, o sistema tentará reutilizar a última
        Lista Piloto FUNDAMENTAL salva em sessão (se existir).
      </div>
    </div>

    <div id="flash-container" class="flash-container">
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for category, message in messages %}
            {% set bs_class = 'danger' if category == 'error' else (category if category in ['success', 'info', 'warning', 'primary'] else 'info') %}
            <div class="alert alert-{{ bs_class }} mb-2" role="alert">
              {{ message }}
            </div>
          {% endfor %}
        {% endif %}
      {% endwith %}
    </div>

    <form id="form-transferencias" method="POST" enctype="multipart/form-data">
      <!-- Dados que vão para o MODELO (A7, A8, B9, J9) -->
      <div class="form-row">
        <div class="form-group col-md-6">
          <label for="diretor_nome">Diretor(a) / Nome padrão (A8)</label>
          <input
            type="text"
            class="form-control"
            name="diretor_nome"
            id="diretor_nome"
            value="Luciana Rocha Augustinho"
            placeholder="Nome do diretor(a) / responsável padrão"
          >
          <small class="helper-text">
            Este nome é inserido no cabeçalho do quadro (campo A8). Você pode editar antes de gerar.
          </small>
        </div>

        <div class="form-group col-md-6">
          <label for="data_quadro">Data do quadro (J9)</label>
          <input
            type="date"
            class="form-control"
            name="data_quadro"
            id="data_quadro"
          >
          <small class="helper-text">
            Se não informar, o sistema usa a data de hoje automaticamente.
          </small>
        </div>
      </div>

      <!-- Período de filtro -->
      <div class="form-row">
        <div class="form-group col-md-6">
          <label for="period_start">Data inicial do período</label>
          <input
            type="date"
            class="form-control"
            name="period_start"
            id="period_start"
            required
          >
          <small class="helper-text">
            Início do período de análise.
          </small>
        </div>
        <div class="form-group col-md-6">
          <label for="period_end">Data final do período</label>
          <input
            type="date"
            class="form-control"
            name="period_end"
            id="period_end"
            required
          >
          <small class="helper-text">
            Fim do período de análise.
          </small>
        </div>
      </div>

      <!-- Rodapé/Responsável -->
      <div class="form-group">
        <label for="responsavel">Responsável pelo preenchimento (B9)</label>
        <input
          type="text"
          class="form-control"
          name="responsavel"
          id="responsavel"
          placeholder="Nome do responsável pelo quadro"
          required
        >
        <small class="helper-text">
          Este nome será inserido automaticamente no modelo (B9).
        </small>
      </div>

      <!-- Upload Fundamental -->
      <div class="upload-group">
        <div class="section-title">Lista Piloto – Ensino Fundamental</div>
        <div id="drop-fundamental" class="dropzone">
          <div class="dropzone-icon-circle">
            <i class="fas fa-file-excel"></i>
          </div>
          <div class="dropzone-text-block">
            <p class="dropzone-title">Arraste o arquivo aqui ou clique para selecionar</p>
            <p class="dropzone-subtitle">Formatos aceitos: .xlsx, .xls, .xlsm</p>
            <div class="dropzone-filename" id="fundamental-filename">
              Nenhum arquivo selecionado.
            </div>
          </div>
          <input
            type="file"
            id="lista_fundamental"
            name="lista_fundamental"
            accept=".xlsx,.xls,.xlsm"
          >
        </div>
        <div class="helper-text">
          Se você não selecionar nada, o sistema tentará usar a última Lista Piloto FUNDAMENTAL salva em sessão.
        </div>
      </div>

      <!-- Upload EJA (opcional / pode estar desativada no backend) -->
      {% if enable_eja %}
        <div class="upload-group">
          <div class="section-title">
            Lista Piloto – EJA
            <span class="badge-optional">Opcional</span>
          </div>
          <div id="drop-eja" class="dropzone">
            <div class="dropzone-icon-circle">
              <i class="fas fa-file-excel"></i>
            </div>
            <div class="dropzone-text-block">
              <p class="dropzone-title">Arraste o arquivo aqui ou clique para selecionar</p>
              <p class="dropzone-subtitle">Formatos aceitos: .xlsx, .xls, .xlsm</p>
              <div class="dropzone-filename" id="eja-filename">
                Nenhum arquivo selecionado.
              </div>
            </div>
            <input
              type="file"
              id="lista_eja"
              name="lista_eja"
              accept=".xlsx,.xls,.xlsm"
            >
          </div>
          <div class="helper-text">
            Opcional. Se não enviar, o quadro será gerado apenas com o Fundamental.
          </div>
        </div>
      {% else %}
        {# EJA desativada: mantemos o formulário limpo #}
      {% endif %}

      <button type="submit" class="btn btn-primary btn-block btn-generate">
        Gerar Quadro de Transferências
      </button>

      <div class="back-links">
        <a href="{{ url_for('quadros') }}" class="btn btn-light btn-sm">
          <i class="fas fa-arrow-left"></i> Voltar para Quadros
        </a>
        <span class="helper-text">
          O arquivo Excel será baixado automaticamente após a geração.
        </span>
      </div>
    </form>
  </div>
{% endblock %}

{% block extra_scripts %}
<script>
  function setupDropzone(inputId, dropId, labelId) {
    const input = document.getElementById(inputId);
    const drop = document.getElementById(dropId);
    const label = document.getElementById(labelId);

    if (!input || !drop || !label) return;

    input.addEventListener('change', function () {
      if (input.files && input.files.length > 0) {
        label.textContent = input.files[0].name;
      } else {
        label.textContent = 'Nenhum arquivo selecionado.';
      }
    });

    ['dragenter', 'dragover'].forEach(evtName => {
      drop.addEventListener(evtName, function (e) {
        e.preventDefault();
        e.stopPropagation();
        drop.classList.add('dragover');
      });
    });

    ['dragleave', 'drop'].forEach(evtName => {
      drop.addEventListener(evtName, function (e) {
        e.preventDefault();
        e.stopPropagation();
        drop.classList.remove('dragover');
      });
    });

    drop.addEventListener('drop', function (e) {
      const dt = e.dataTransfer;
      if (!dt || !dt.files || !dt.files.length) return;

      const file = dt.files[0];
      const name = (file.name || '').toLowerCase();
      const allowed = ['.xlsx', '.xls', '.xlsm'];
      const isValid = allowed.some(ext => name.endsWith(ext));

      if (!isValid) {
        alert('Formato inválido. Use arquivos .xlsx, .xls ou .xlsm.');
        return;
      }

      const newDt = new DataTransfer();
      newDt.items.add(file);
      input.files = newDt.files;

      label.textContent = file.name;
    });
  }

  function renderFlashMessages(messages) {
    const container = document.getElementById('flash-container');
    if (!container) return;

    container.innerHTML = '';
    (messages || []).forEach(item => {
      const div = document.createElement('div');
      div.className = `alert alert-${item.bsClass} mb-2`;
      div.setAttribute('role', 'alert');
      div.textContent = item.text;
      container.appendChild(div);
    });
  }

  function extractAlertsFromHTML(htmlText) {
    try {
      const parser = new DOMParser();
      const doc = parser.parseFromString(htmlText, 'text/html');
      const alerts = Array.from(doc.querySelectorAll('.alert'));
      if (!alerts.length) return [];

      return alerts.map(a => {
        const classList = Array.from(a.classList);
        const bs = (classList.find(c => c.startsWith('alert-')) || 'alert-info').replace('alert-', '');
        return {
          bsClass: bs,
          text: (a.textContent || '').trim()
        };
      }).filter(x => x.text);
    } catch (e) {
      return [];
    }
  }

  let transferenciasDownloading = false;

  function showTransferenciasLoading() {
    transferenciasDownloading = true;

    const existing = document.getElementById('loading-overlay');
    if (existing) existing.remove();

    const overlay = document.createElement('div');
    overlay.id = 'loading-overlay';
    overlay.style.position = 'fixed';
    overlay.style.inset = '0';
    overlay.style.background = 'rgba(0,0,0,0.55)';
    overlay.style.display = 'flex';
    overlay.style.alignItems = 'center';
    overlay.style.justifyContent = 'center';
    overlay.style.zIndex = '9999';

    overlay.innerHTML = `
      <div style="text-align:center;color:white;font-family:Montserrat,Arial,sans-serif;">
        <div class="spinner-border" role="status" style="width:3rem;height:3rem;border-width:0.3rem;">
          <span class="sr-only">Carregando...</span>
        </div>
        <p style="margin-top:12px;font-size:0.95rem;">
          Gerando Quadro de Transferências, aguarde...
        </p>
      </div>
    `;

    document.body.appendChild(overlay);
  }

  function hideTransferenciasLoading() {
    transferenciasDownloading = false;
    const existing = document.getElementById('loading-overlay');
    if (existing) existing.remove();
  }

  document.addEventListener('DOMContentLoaded', function () {
    setupDropzone('lista_fundamental', 'drop-fundamental', 'fundamental-filename');
    setupDropzone('lista_eja', 'drop-eja', 'eja-filename');

    const form = document.getElementById('form-transferencias');
    if (form) {
      form.addEventListener('submit', async function (e) {
        e.preventDefault();

        renderFlashMessages([]);
        showTransferenciasLoading();

        const formData = new FormData(form);

        try {
          const response = await fetch(form.action || window.location.href, {
            method: 'POST',
            body: formData
          });

          const contentType = (response.headers.get('Content-Type') || '').toLowerCase();

          // Sucesso: arquivo excel
          if (response.ok && contentType.includes('application/vnd.openxmlformats-officedocument.spreadsheetml.sheet')) {
            const blob = await response.blob();

            let filename = 'Quadro_de_Transferencias.xlsx';
            const disposition = response.headers.get('Content-Disposition');
            if (disposition) {
              const filenameMatch = /filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/.exec(disposition);
              if (filenameMatch && filenameMatch[1]) {
                filename = filenameMatch[1].replace(/['"]/g, '');
              }
            }

            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            a.remove();
            window.URL.revokeObjectURL(url);
            return;
          }

          // Erro: geralmente vem HTML com flashes
          const text = await response.text();
          const extracted = extractAlertsFromHTML(text);

          if (extracted.length) {
            renderFlashMessages(extracted);
          } else {
            renderFlashMessages([{
              bsClass: 'warning',
              text: 'Não foi possível gerar o Quadro de Transferências. Verifique os dados e tente novamente.'
            }]);
          }
        } catch (err) {
          console.error(err);
          renderFlashMessages([{
            bsClass: 'danger',
            text: 'Erro de rede ao gerar o Quadro de Transferências.'
          }]);
        } finally {
          hideTransferenciasLoading();
        }
      });
    }
  });
</script>
{% endblock %}