{% extends "base.html" %}

{% block title %}Carteirinhas - Secretaria{% endblock %}

{% block extra_styles %}
  .carteirinhas-wrapper {
    position: relative;
    z-index: 1;
    background: rgba(255, 255, 255, 0.98);
    padding: 32px 28px 24px;
    border-radius: 16px;
    box-shadow: 0 18px 40px rgba(0, 0, 0, 0.35);
    width: 100%;
    max-width: 960px;
    color: #283E51;
  }

  .carteirinhas-header h2 {
    font-size: 1.4rem;
    font-weight: 600;
    margin-bottom: 4px;
  }

  .carteirinhas-header p {
    font-size: 0.9rem;
    color: #5d6c7a;
    margin-bottom: 18px;
  }

  .steps-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 16px;
  }

  .step-card {
    border-radius: 12px;
    border: 1px solid #e0e6ed;
    background: #ffffff;
    padding: 16px 18px 18px;
    box-shadow: 0 6px 14px rgba(15, 23, 42, 0.06);
  }

  .step-header {
    display: flex;
    align-items: center;
    margin-bottom: 10px;
  }

  .step-icon {
    width: 40px;
    height: 40px;
    border-radius: 999px;
    background: linear-gradient(135deg, #283E51, #4B79A1);
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 10px;
    flex-shrink: 0;
  }

  .step-icon i {
    color: #ffffff;
    font-size: 1.1rem;
  }

  .step-title {
    margin: 0;
    font-size: 1rem;
    font-weight: 600;
    color: #283E51;
  }

  .step-subtitle {
    font-size: 0.85rem;
    color: #6b7280;
    margin: 2px 0 0;
  }

  .step-body p {
    font-size: 0.85rem;
    color: #6b7280;
    margin-bottom: 10px;
  }

  .step-body small.form-text {
    font-size: 0.8rem;
  }

  .custom-file-label::after {
    content: "Procurar";
  }

  #flash-messages {
    margin-bottom: 12px;
  }

  #multi-upload-section {
    margin-top: 10px;
    border-radius: 10px;
    padding: 12px 12px 14px;
    background-color: #f8fbff;
    border: 1px dashed #cbd5e1;
  }

  .multi-upload-group {
    margin-bottom: 10px;
    padding-bottom: 8px;
    border-bottom: 1px dashed #e5e7eb;
  }

  .multi-upload-group:last-child {
    border-bottom: none;
    margin-bottom: 0;
  }

  .actions-row {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 10px;
  }

  .btn-primary {
    background: linear-gradient(135deg, #283E51, #4B79A1);
    border: none;
    border-radius: 999px;
    font-weight: 600;
    font-size: 0.9rem;
    padding: 8px 18px;
  }

  .btn-primary:hover {
    background: linear-gradient(135deg, #1f3040, #3d6384);
  }

  .btn-secondary,
  .btn-info {
    border-radius: 999px;
    font-size: 0.85rem;
    padding: 6px 14px;
  }

  .back-dashboard {
    margin-top: 20px;
    text-align: right;
  }

  .back-dashboard .btn-back {
    border-radius: 999px;
    font-size: 0.9rem;
    padding: 8px 18px;
    display: inline-flex;
    align-items: center;
    gap: 6px;
  }

  @media (max-width: 768px) {
    .carteirinhas-wrapper {
      padding: 24px 18px 20px;
    }
  }
{% endblock %}

{% block content %}
  <div class="carteirinhas-wrapper">
    <div class="carteirinhas-header">
      <h2>Carteirinhas</h2>
      <p>
        Gere as carteirinhas a partir da lista piloto e envie as fotos dos alunos
        individualmente ou em lote.
      </p>
    </div>

    {# mensagens de sucesso/erro do flash() #}
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div id="flash-messages">
          {% for category, message in messages %}
            {% set bs_class =
                 'danger' if category in ['error','danger'] else
                 'success' if category == 'success' else
                 'info' %}
            <div class="alert alert-{{ bs_class }} mb-2" role="alert">
              {{ message }}
            </div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <div class="steps-grid">
      {# ETAPA 1 – Lista piloto (Excel) #}
      <div class="step-card">
        <div class="step-header">
          <div class="step-icon">
            <i class="fas fa-file-excel"></i>
          </div>
          <div>
            <p class="step-title">Etapa 1 – Lista Piloto (Excel)</p>
            <p class="step-subtitle">
              Envie a lista do Ensino Fundamental para gerar as carteirinhas.
            </p>
          </div>
        </div>
        <div class="step-body">
          <p>
            Caso já tenha enviado a lista piloto no início do sistema,
            este envio é opcional. Use apenas se precisar atualizar a planilha.
          </p>
          <form method="POST" enctype="multipart/form-data" onsubmit="showLoading()">
            <div class="form-group">
              <div class="custom-file">
                <input
                  type="file"
                  class="custom-file-input"
                  id="excel_file"
                  name="excel_file"
                  accept=".xlsx,.xls,.xlsm"
                >
                <label class="custom-file-label" for="excel_file">
                  Selecione a Lista do Fundamental (opcional)
                </label>
              </div>
              <small class="form-text text-muted">
                Formatos aceitos: .xlsx, .xls, .xlsm
              </small>
            </div>
            <button type="submit" class="btn btn-primary">
              Gerar carteirinhas
            </button>
          </form>
        </div>
      </div>

      {# ETAPA 2 – Upload de foto individual #}
      <div class="step-card">
        <div class="step-header">
          <div class="step-icon">
            <i class="fas fa-user-circle"></i>
          </div>
          <div>
            <p class="step-title">Etapa 2 – Foto Individual</p>
            <p class="step-subtitle">
              Envie a foto de um aluno informando o RM correspondente.
            </p>
          </div>
        </div>
        <div class="step-body">
          <form method="POST" action="/upload_foto" enctype="multipart/form-data">
            <div class="form-group">
              <label for="rm_individual">RM do aluno</label>
              <input
                type="text"
                class="form-control"
                id="rm_individual"
                name="rm"
                placeholder="Digite o RM"
              >
            </div>
            <div class="form-group">
              <label for="foto_individual">Foto do aluno</label>
              <input
                type="file"
                class="form-control-file"
                id="foto_individual"
                name="foto_file"
                accept="image/*"
              >
            </div>
            <button type="submit" class="btn btn-secondary">
              Enviar foto
            </button>
          </form>
        </div>
      </div>

      {# ETAPA 3 – Upload de múltiplas fotos #}
      <div class="step-card">
        <div class="step-header">
          <div class="step-icon">
            <i class="fas fa-users"></i>
          </div>
          <div>
            <p class="step-title">Etapa 3 – Múltiplas Fotos</p>
            <p class="step-subtitle">
              Envie várias fotos de alunos de uma só vez.
            </p>
          </div>
        </div>
        <div class="step-body">
          <p>
            Para cada linha informe o RM e selecione a foto correspondente.
            Você pode adicionar quantas linhas forem necessárias.
          </p>

          <button type="button" class="btn btn-info" id="show-multi-upload">
            Mostrar / ocultar formulário de múltiplas fotos
          </button>

          <div id="multi-upload-section" style="display: none;">
            <form
              method="POST"
              action="/upload_multiplas_fotos"
              enctype="multipart/form-data"
              id="multi-upload-form"
            >
              <div id="multi-upload-fields">
                <div class="multi-upload-group">
                  <div class="form-group">
                    <label>RM do aluno</label>
                    <input
                      type="text"
                      class="form-control"
                      name="rm[]"
                      placeholder="Digite o RM"
                    >
                  </div>
                  <div class="form-group">
                    <label>Foto do aluno</label>
                    <input
                      type="file"
                      class="form-control-file"
                      name="foto_file[]"
                      accept="image/*"
                    >
                  </div>
                </div>
              </div>

              <div class="actions-row">
                <button
                  type="button"
                  class="btn btn-secondary"
                  id="add-more"
                >
                  Adicionar outra foto
                </button>
                <button
                  type="submit"
                  class="btn btn-primary"
                >
                  Enviar fotos
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <div class="back-dashboard">
      <a href="{{ url_for('dashboard') }}" class="btn btn-light btn-back">
        <i class="fas fa-arrow-left"></i>
        Voltar ao painel
      </a>
    </div>
  </div>
{% endblock %}

{% block extra_scripts %}
<script>
  // Esconde mensagens flash depois de alguns segundos
  setTimeout(function() {
    var flashDiv = document.getElementById('flash-messages');
    if (flashDiv) {
      flashDiv.style.display = 'none';
    }
  }, 3000);

  // Atualiza o texto do input de arquivo com o nome do arquivo escolhido
  document.addEventListener('DOMContentLoaded', function () {
    var excelInput = document.getElementById('excel_file');
    if (excelInput) {
      excelInput.addEventListener('change', function () {
        var fileName = this.files.length ? this.files[0].name : 'Nenhum arquivo selecionado';
        var label = this.nextElementSibling;
        if (label) {
          label.textContent = fileName;
        }
      });
    }

    var btnToggleMulti = document.getElementById('show-multi-upload');
    var multiSection = document.getElementById('multi-upload-section');
    if (btnToggleMulti && multiSection) {
      btnToggleMulti.addEventListener('click', function() {
        if (multiSection.style.display === 'none' || multiSection.style.display === '') {
          multiSection.style.display = 'block';
        } else {
          multiSection.style.display = 'none';
        }
      });
    }

    var btnAddMore = document.getElementById('add-more');
    var fieldsContainer = document.getElementById('multi-upload-fields');
    if (btnAddMore && fieldsContainer) {
      btnAddMore.addEventListener('click', function() {
        var group = document.createElement('div');
        group.className = 'multi-upload-group';
        group.innerHTML =
          '<div class="form-group">' +
            '<label>RM do aluno</label>' +
            '<input type="text" class="form-control" name="rm[]" placeholder="Digite o RM">' +
          '</div>' +
          '<div class="form-group">' +
            '<label>Foto do aluno</label>' +
            '<input type="file" class="form-control-file" name="foto_file[]" accept="image/*">' +
          '</div>';
        fieldsContainer.appendChild(group);
      });
    }
  });

  // Tela de carregamento ao enviar a lista de carteirinhas
  function showLoading() {
    var existingOverlay = document.getElementById('loading-overlay');
    if (existingOverlay) {
      existingOverlay.remove();
    }
    var loadingOverlay = document.createElement('div');
    loadingOverlay.id = 'loading-overlay';
    loadingOverlay.style.position = 'fixed';
    loadingOverlay.style.top = '0';
    loadingOverlay.style.left = '0';
    loadingOverlay.style.right = '0';
    loadingOverlay.style.bottom = '0';
    loadingOverlay.style.background = 'rgba(0,0,0,0.5)';
    loadingOverlay.style.display = 'flex';
    loadingOverlay.style.alignItems = 'center';
    loadingOverlay.style.justifyContent = 'center';
    loadingOverlay.style.zIndex = '9999';
    loadingOverlay.innerHTML =
      '<div style="text-align: center; color: white; font-family: Arial, sans-serif;">' +
        '<svg width="3.0cm" height="4.5cm" viewBox="0 0 6.0 9.0" xmlns="http://www.w3.org/2000/svg">' +
          '<rect x="0.3" y="0.3" width="5.4" height="8.4" rx="0.3" ry="0.3" stroke="white" stroke-width="0.1" fill="none" />' +
          '<rect id="badge-fill" x="0.3" y="8.7" width="5.4" height="0" rx="0.3" ry="0.3" fill="white" />' +
        '</svg>' +
        '<p id="loading-text" style="margin-top: 0.2cm;">Gerando carteirinhas...</p>' +
      '</div>';
    document.body.appendChild(loadingOverlay);
    var fillHeight = 0;
    var maxHeight = 8.4;
    var interval = setInterval(function() {
      fillHeight += 0.2;
      if (fillHeight > maxHeight) {
        fillHeight = maxHeight;
        clearInterval(interval);
      }
      var badgeFill = document.getElementById('badge-fill');
      if (badgeFill) {
        badgeFill.setAttribute('y', 8.7 - fillHeight);
        badgeFill.setAttribute('height', fillHeight);
      }
    }, 100);
  }
</script>
{% endblock %}
